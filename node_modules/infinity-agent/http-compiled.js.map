{"version":3,"sources":["http.js"],"names":[],"mappings":"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","file":"http-compiled.js","sourcesContent":["'use strict';\n\nvar net = require('net');\nvar util = require('util');\nvar EventEmitter = require('events').EventEmitter;\n\nvar debug;\n\nif (util.debuglog) {\n  debug = util.debuglog('http');\n} else {\n  debug = function (x) {\n    if (process.env.NODE_DEBUG && /http/.test(process.env.NODE_DEBUG)) {\n      console.error('HTTP: %s', x);\n    }\n  };\n}\n\n// New Agent code.\n\n// The largest departure from the previous implementation is that\n// an Agent instance holds connections for a variable number of host:ports.\n// Surprisingly, this is still API compatible as far as third parties are\n// concerned. The only code that really notices the difference is the\n// request object.\n\n// Another departure is that all code related to HTTP parsing is in\n// ClientRequest.onSocket(). The Agent is now *strictly*\n// concerned with managing a connection pool.\n\nfunction Agent(options) {\n  if (!(this instanceof Agent))\n    return new Agent(options);\n\n  EventEmitter.call(this);\n\n  var self = this;\n\n  self.defaultPort = 80;\n  self.protocol = 'http:';\n\n  self.options = util._extend({}, options);\n\n  // don't confuse net and make it think that we're connecting to a pipe\n  self.options.path = null;\n  self.requests = {};\n  self.sockets = {};\n  self.freeSockets = {};\n  self.keepAliveMsecs = self.options.keepAliveMsecs || 1000;\n  self.keepAlive = self.options.keepAlive || false;\n  self.maxSockets = self.options.maxSockets || Agent.defaultMaxSockets;\n  self.maxFreeSockets = self.options.maxFreeSockets || 256;\n\n  self.on('free', function(socket, options) {\n    var name = self.getName(options);\n    debug('agent.on(free)', name);\n\n    if (!socket.destroyed &&\n        self.requests[name] && self.requests[name].length) {\n      self.requests[name].shift().onSocket(socket);\n      if (self.requests[name].length === 0) {\n        // don't leak\n        delete self.requests[name];\n      }\n    } else {\n      // If there are no pending requests, then put it in\n      // the freeSockets pool, but only if we're allowed to do so.\n      var req = socket._httpMessage;\n      if (req &&\n          req.shouldKeepAlive &&\n          !socket.destroyed &&\n          self.options.keepAlive) {\n        var freeSockets = self.freeSockets[name];\n        var freeLen = freeSockets ? freeSockets.length : 0;\n        var count = freeLen;\n        if (self.sockets[name])\n          count += self.sockets[name].length;\n\n        if (count >= self.maxSockets || freeLen >= self.maxFreeSockets) {\n          self.removeSocket(socket, options);\n          socket.destroy();\n        } else {\n          freeSockets = freeSockets || [];\n          self.freeSockets[name] = freeSockets;\n          socket.setKeepAlive(true, self.keepAliveMsecs);\n          socket.unref();\n          socket._httpMessage = null;\n          self.removeSocket(socket, options);\n          freeSockets.push(socket);\n        }\n      } else {\n        self.removeSocket(socket, options);\n        socket.destroy();\n      }\n    }\n  });\n}\n\nutil.inherits(Agent, EventEmitter);\nexports.Agent = Agent;\n\nAgent.defaultMaxSockets = Infinity;\n\nAgent.prototype.createConnection = net.createConnection;\n\n// Get the key for a given set of request options\nAgent.prototype.getName = function(options) {\n  var name = '';\n\n  if (options.host)\n    name += options.host;\n  else\n    name += 'localhost';\n\n  name += ':';\n  if (options.port)\n    name += options.port;\n  name += ':';\n  if (options.localAddress)\n    name += options.localAddress;\n  name += ':';\n  return name;\n};\n\nAgent.prototype.addRequest = function(req, options) {\n  // Legacy API: addRequest(req, host, port, path)\n  if (typeof options === 'string') {\n    options = {\n      host: options,\n      port: arguments[2],\n      path: arguments[3]\n    };\n  }\n\n  // If we are not keepAlive agent and maxSockets is Infinity\n  // then disable shouldKeepAlive\n  if (!this.keepAlive && !Number.isFinite(this.maxSockets)) {\n    req._last = true;\n    req.shouldKeepAlive = false;\n  }\n\n  var name = this.getName(options);\n  if (!this.sockets[name]) {\n    this.sockets[name] = [];\n  }\n\n  var freeLen = this.freeSockets[name] ? this.freeSockets[name].length : 0;\n  var sockLen = freeLen + this.sockets[name].length;\n\n  if (freeLen) {\n    // we have a free socket, so use that.\n    var socket = this.freeSockets[name].shift();\n    debug('have free socket');\n\n    // don't leak\n    if (!this.freeSockets[name].length)\n      delete this.freeSockets[name];\n\n    socket.ref();\n    req.onSocket(socket);\n    this.sockets[name].push(socket);\n  } else if (sockLen < this.maxSockets) {\n    debug('call onSocket', sockLen, freeLen);\n    // If we are under maxSockets create a new one.\n    req.onSocket(this.createSocket(req, options));\n  } else {\n    debug('wait for socket');\n    // We are over limit so we'll add it to the queue.\n    if (!this.requests[name]) {\n      this.requests[name] = [];\n    }\n    this.requests[name].push(req);\n  }\n};\n\nAgent.prototype.createSocket = function(req, options) {\n  var self = this;\n  options = util._extend({}, options);\n  options = util._extend(options, self.options);\n\n  if (!options.servername) {\n    options.servername = options.host;\n    if (req) {\n      var hostHeader = req.getHeader('host');\n      if (hostHeader) {\n        options.servername = hostHeader.replace(/:.*$/, '');\n      }\n    }\n  }\n\n  var name = self.getName(options);\n\n  debug('createConnection', name, options);\n  options.encoding = null;\n  var s = self.createConnection(options);\n  if (!self.sockets[name]) {\n    self.sockets[name] = [];\n  }\n  this.sockets[name].push(s);\n  debug('sockets', name, this.sockets[name].length);\n\n  function onFree() {\n    self.emit('free', s, options);\n  }\n  s.on('free', onFree);\n\n  function onClose(err) {\n    debug('CLIENT socket onClose');\n    // This is the only place where sockets get removed from the Agent.\n    // If you want to remove a socket from the pool, just close it.\n    // All socket errors end in a close event anyway.\n    self.removeSocket(s, options);\n  }\n  s.on('close', onClose);\n\n  function onRemove() {\n    // We need this function for cases like HTTP 'upgrade'\n    // (defined by WebSockets) where we need to remove a socket from the\n    // pool because it'll be locked up indefinitely\n    debug('CLIENT socket onRemove');\n    self.removeSocket(s, options);\n    s.removeListener('close', onClose);\n    s.removeListener('free', onFree);\n    s.removeListener('agentRemove', onRemove);\n  }\n  s.on('agentRemove', onRemove);\n  return s;\n};\n\nAgent.prototype.removeSocket = function(s, options) {\n  var name = this.getName(options);\n  debug('removeSocket', name, 'destroyed:', s.destroyed);\n  var sets = [this.sockets];\n\n  // If the socket was destroyed, remove it from the free buffers too.\n  if (s.destroyed)\n    sets.push(this.freeSockets);\n\n  for (var sk = 0; sk < sets.length; sk++) {\n    var sockets = sets[sk];\n\n    if (sockets[name]) {\n      var index = sockets[name].indexOf(s);\n      if (index !== -1) {\n        sockets[name].splice(index, 1);\n        // Don't leak\n        if (sockets[name].length === 0)\n          delete sockets[name];\n      }\n    }\n  }\n\n  if (this.requests[name] && this.requests[name].length) {\n    debug('removeSocket, have a request, make a socket');\n    var req = this.requests[name][0];\n    // If we have pending requests and a socket gets closed make a new one\n    this.createSocket(req, options).emit('free');\n  }\n};\n\nAgent.prototype.destroy = function() {\n  var sets = [this.freeSockets, this.sockets];\n  for (var s = 0; s < sets.length; s++) {\n    var set = sets[s];\n    var keys = Object.keys(set);\n    for (var v = 0; v < keys.length; v++) {\n      var setName = set[keys[v]];\n      for (var n = 0; n < setName.length; n++) {\n        setName[n].destroy();\n      }\n    }\n  }\n};\n\nexports.globalAgent = new Agent();\n"]}