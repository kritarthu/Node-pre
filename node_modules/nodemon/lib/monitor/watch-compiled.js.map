{"version":3,"sources":["watch.js"],"names":[],"mappings":"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","file":"watch-compiled.js","sourcesContent":["module.exports.watch = watch;\nmodule.exports.resetWatchers = resetWatchers;\n\nvar debug = require('debug')('nodemon:watch');\nvar debugRoot = require('debug')('nodemon');\nvar Promise = require('es6-promise').Promise; // jshint ignore:line\nvar chokidar = require('chokidar');\nvar undefsafe = require('undefsafe');\nvar config = require('../config');\nvar path = require('path');\nvar utils = require('../utils');\nvar bus = utils.bus;\nvar match = require('./match');\nvar watchers = [];\nvar debouncedBus;\n\nbus.on('reset', resetWatchers);\n\nfunction resetWatchers() {\n  debug('resetting watchers');\n  watchers.forEach(function (watcher) {\n    watcher.close();\n  });\n  watchers = [];\n}\n\n\nfunction watch() {\n  if (watchers.length) {\n    debug('early exit on watch, still watching (%s)', watchers.length);\n    return;\n  }\n\n  var dirs = [].slice.call(config.dirs);\n\n  debugRoot('start watch on: %s', dirs.join(', '));\n  debugRoot('ignore dirs regex(%s)', config.options.ignore.re);\n\n  var promises = [];\n  var watchedFiles = [];\n\n  dirs.forEach(function (dir) {\n    var promise = new Promise(function (resolve) {\n      var ignored = config.options.ignore.re;\n      var dotFilePattern = /[\\/\\\\]\\./;\n\n      // don't ignore dotfiles if explicitly watched.\n      if (!dir.match(dotFilePattern)) {\n        ignored = [ignored, dotFilePattern];\n      }\n\n      var watcher = chokidar.watch(dir, {\n        ignored: ignored,\n        persistent: true,\n        usePolling: config.options.legacyWatch || false,\n        interval: config.options.pollingInterval,\n      });\n\n      watcher.ready = false;\n\n      var total = 0;\n\n      watcher.on('change', filterAndRestart);\n      watcher.on('add', function (file) {\n        if (watcher.ready) {\n          return filterAndRestart(file);\n        }\n\n        watchedFiles.push(file);\n        total++;\n        debug('watching dir: %s', file);\n      });\n      watcher.on('ready', function () {\n        watcher.ready = true;\n        resolve(total);\n        debugRoot('watch is complete');\n      });\n\n      watcher.on('error', function (error) {\n        if (error.code === 'EINVAL') {\n          utils.log.error('Internal watch failed. Likely cause: too many ' +\n            'files being watched (perhaps from the root of a drive?\\n' +\n            'See https://github.com/paulmillr/chokidar/issues/229 for details');\n        } else {\n          utils.log.error('Internal watch failed: ' + error.message);\n          process.exit(1);\n        }\n      });\n\n      watchers.push(watcher);\n    });\n    promises.push(promise);\n  });\n\n  return Promise.all(promises).then(function (res) {\n    var total = res.reduce(function (acc, curr) {\n      acc += curr;\n      return acc;\n    }, 0);\n\n    var count = total.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\n    utils.log.detail('watching ' + count + ' files');\n    return watchedFiles;\n  });\n}\n\nfunction filterAndRestart(files) {\n  if (!Array.isArray(files)) {\n    files = [files];\n  }\n  if (files.length) {\n    if (utils.isWindows) {\n      // ensure the drive letter is in uppercase (c:\\foo -> C:\\foo)\n      files = files.map(function (f) {\n        return f[0].toUpperCase() + f.slice(1);\n      });\n    }\n\n    var cwd = process.cwd();\n    utils.log.detail('files triggering change check: ' +\n      files.map(function (file) {\n        return path.relative(cwd, file);\n      }).join(', '));\n\n    var matched = match(\n      files,\n      config.options.monitor,\n      undefsafe(config, 'options.execOptions.ext')\n    );\n\n    utils.log.detail('changes after filters (before/after): ' +\n      [files.length, matched.result.length].join('/'));\n\n    // reset the last check so we're only looking at recently modified files\n    config.lastStarted = Date.now();\n\n    if (matched.result.length) {\n      if (config.options.delay > 0) {\n        utils.log.detail('delaying restart for ' + config.options.delay + 'ms');\n        if (debouncedBus === undefined) {\n          debouncedBus = debounce(restartBus, config.options.delay);\n        }\n        debouncedBus(matched);\n      } else {\n        return restartBus(matched);\n      }\n    }\n  }\n}\n\n\nfunction restartBus(matched) {\n  utils.log.status('restarting due to changes...');\n  matched.result.map(function (file) {\n    utils.log.detail(path.relative(process.cwd(), file));\n  });\n\n  if (config.options.verbose) {\n    utils.log._log('');\n  }\n\n  bus.emit('restart', matched.result);\n}\n\nfunction debounce(fn, delay) {\n  var timer = null;\n  return function () {\n    var context = this;\n    var args = arguments;\n    clearTimeout(timer);\n    timer = setTimeout(function () {\n      fn.apply(context, args);\n    }, delay);\n  };\n}\n"]}